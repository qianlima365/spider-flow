<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>SpiderFlow</title>
		<link rel="stylesheet" href="js/layui/css/layui.css" />
		<link rel="stylesheet" id="theSkin" />
		<link rel="stylesheet" href="css/index.css" />
		<script>SPIDER_FLOW_VERSION = 'v0.5.0'</script>
		<script type="text/javascript" src="js/layui/layui.all.js" ></script>
        <script src="js/cron/jquery-2.1.4.min.js"></script>
		<script>
			// 平台入口页 TOKEN 守卫：本地令牌或 Cookie 登录态
			(function(){
				// 步骤1：定义工具函数（读取令牌 / 顶层跳转）
				// 从 localStorage 读取指定名称的令牌；过滤无效值（undefined/null/空白）
				function readToken(name){
					var v = localStorage.getItem(name);
					if(!v || v === 'undefined' || v === 'null' || (/^\s*$/.test(v))){ return ''; }
					return v;
				}
				// 返回平台令牌：优先使用普通用户 token，其次为管理员 token
				function getPlatformToken(){
					return readToken('userToken') || readToken('adminToken') || '';
				}
				// 顶层重定向：如果在 iframe 中则跳转顶层，否则当前页跳转
				function topRedirect(url){
					if(window.top){ window.top.location.replace(url); } else { window.location.replace(url); }
				}

				// 步骤2：读取本地平台令牌（如后续需要可用于请求头）
				var token = getPlatformToken();

				// 步骤3：仅使用 jQuery 的 AJAX 调用 /auth/me 校验登录态
				// 成功（已登录）：留在首页继续加载；失败：清理本地令牌并跳转登录页
				$.ajax({
					url: '/auth/me',
					method: 'GET',
					headers: { 'Accept': 'application/json' },
					xhrFields: { withCredentials: true },
					crossDomain: true,
					dataType: 'json'
				})
				// 已登录：无操作，停留在首页即可
				.done(function(){ /* 已登录，继续加载首页 */ })
				.fail(function(){
					// 未登录或校验失败：清理本地令牌并统一跳转登录页
					try{ 
						localStorage.removeItem('userToken'); 
						localStorage.removeItem('adminToken'); 
					}catch(e){}
				topRedirect('/login.html');
				});

			// 步骤4：配置全局 AJAX 行为
			// 全局 AJAX 配置：
			// - 请求前附加本地令牌到请求头 X-Token（若存在）
			// - 请求完成后若状态码为 401，统一清理本地令牌并跳转登录页
			if(window.$ && $.ajaxSetup){
				$.ajaxSetup({
				beforeSend: function(xhr){
					// 兼容普通用户与管理员两种令牌：优先用户令牌，其次管理员令牌
					var tkUser = readToken('userToken');
					var tkAdmin = readToken('adminToken');
					if(tkUser){
						xhr.setRequestHeader('X-Token', tkUser);
					}else if(tkAdmin){
						xhr.setRequestHeader('X-Admin-Token', tkAdmin);
					}
				},
				complete: function(xhr){
					if(xhr && xhr.status === 401){
						try{ 
							localStorage.removeItem('userToken'); 
							localStorage.removeItem('adminToken'); 
						}catch(e){}
					topRedirect('/login.html');
					}
				}
				});
			}
			})();
		</script>
		<script type="text/javascript" src="js/index.js" ></script>
	</head>
	<body class="layui-layout layui-layout-admin">
		<div class="layui-header">
			<div class="layui-logo">SpiderFlow</div>
			<ul class="layui-nav layui-layout-left"></ul>
			<ul class="layui-nav layui-layout-right">
				<li class="layui-nav-item">
					<a href="javascript:;" style="padding: 0 20px;">
						主题
						</a>
					<dl class="layui-nav-child">
						<dd><a data-value="layui-blue">默认</a></dd>
						<dd><a data-value="layui-black-gray">黑色</a></dd>
					</dl>
				</li>
			<li class="layui-nav-item" id="nav-user" style="margin-left: 10px;">
                <a href="javascript:;" style="padding: 0 20px; display: flex; align-items: center; gap: 6px;">
                    <span id="nav-avatar" class="avatar" style="width:24px;height:24px;border-radius:50%;background:#1E9FFF;color:#fff;display:inline-flex;align-items:center;justify-content:center;font-size:12px;">U</span>
                    <span id="nav-username">未登录</span>
                    <i class="layui-icon layui-icon-down" style="font-size:12px;"></i>
                </a>
                <dl class="layui-nav-child">
                    <dd><a href="javascript:;" id="nav-admin">系统管理</a></dd>
                    <dd><a href="/profile.html" target="_blank">个人中心</a></dd>
                    <dd><a id="logout-link" href="javascript:;">退出</a></dd>
                </dl>
            </li>
			</ul>

            <script>
            (function(){
                // 统一的退出调用：仅使用 jQuery 的 $.ajax
                function callLogout(){
                    return new Promise(function(resolve){
                        $.ajax({
                            url: '/auth/logout',
                            method: 'POST',
                            headers: { 'Accept': 'application/json' },
                            xhrFields: { withCredentials: true },
                            crossDomain: true,
                            complete: function(){ resolve(); }
                        });
                    });
                }
                function initUserMenu(){
                    var username = localStorage.getItem('adminUsername') || '未登录';
                    var token = localStorage.getItem('adminToken') || '';
                    var nameEl = document.getElementById('nav-username');
                    var avatarEl = document.getElementById('nav-avatar');
                    if(nameEl){ nameEl.textContent = username; }
                    if(avatarEl){
                        var ch = (username && username !== '未登录') ? username.charAt(0).toUpperCase() : 'U';
                        avatarEl.textContent = ch;
                    }
                    var logout = document.getElementById('logout-link');
                    if(logout){
                        logout.addEventListener('click', function(e){
                            e.preventDefault();
                            callLogout().finally(function(){
                                try{
                                    localStorage.removeItem('adminToken');
                                    localStorage.removeItem('adminUsername');
                                    localStorage.removeItem('userToken');
                                    localStorage.removeItem('username');
                                }catch(err){}
                                if(window.top){ window.top.location.replace('/login.html'); } else { window.location.replace('/login.html'); }
                            });
                        });
                    }
                }
                document.addEventListener('DOMContentLoaded', function(){
                    initUserMenu();
                    var admin = document.getElementById('nav-admin');
                    if(admin){
                        admin.addEventListener('click', function(){
                            // 使用相对路径，兼容反向代理或上下文路径
                            window.location.href = 'admin.html';
                        });
                    }
                });
            })();
            </script>
		</div>
		<div class="layui-side">
			<div class="layui-side-scroll menu-list">
				<ul class="layui-nav layui-nav-tree">
					<li class="layui-nav-item layui-nav-itemed layui-this"><a data-link="spiderList.html" title="爬虫列表">爬虫列表</a></li>
					<li class="layui-nav-item layui-nav-itemed"><a data-link="variables.html" title="全局变量">全局变量</a></li>
					<li class="layui-nav-item layui-nav-itemed"><a data-link="functions.html" title="自定义函数">自定义函数</a></li>
					<li class="layui-nav-item layui-nav-itemed"><a data-link="datasources.html" title="数据源管理">数据源管理</a></li>
				</ul>
			</div>
		</div>
		<div class="layui-body">
			<div class="layui-tab" lay-filter="admin-tab" lay-allowClose="true">
		    	<ul id="layuiTab" class="layui-tab-title admin-unselect" unselectable="on" lay-allowClose="false">
			    	<li class="layui-this layui-tab-hidden-close" lay-id="welcome">爬虫列表</li>
		    	</ul>
		    	<div class="layui-tab-content">
		    		<div class="layui-tab-item layui-show">
		    			<iframe src="spiderList.html" width="100%" height="100%" scrolling="yes" frameborder="0"></iframe>
		    		</div>
		    	</div>
		    </div>
		</div>
		<script>
			var title = $(".layui-logo");
			title.append('<span class="version-no">' + SPIDER_FLOW_VERSION + '</span>');
		</script>
	</body>
</html>