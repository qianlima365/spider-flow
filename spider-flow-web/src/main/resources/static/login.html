<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>登录</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    /* 作用域仅限登录页容器 */
    #login-app { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: #f5f7fa; font-family: Arial, sans-serif; }
    .login-card { width: 360px; background: #fff; border: 1px solid #eaeaea; border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.08); }
    .login-header { padding: 16px; border-bottom: 1px solid #f0f0f0; font-weight: 600; text-align: center; }
    .login-body { padding: 16px; display: grid; gap: 12px; }
    .login-row { display: grid; gap: 6px; }
    .login-input { padding: 10px 12px; border: 1px solid #d9d9d9; border-radius: 6px; outline: none; }
    .login-input:focus { border-color: #1890ff; }
    .login-btn { padding: 10px 12px; border: none; border-radius: 6px; background: #1890ff; color: #fff; cursor: pointer; width: 100%; }
    .oidc-btn { width: auto; min-width: 200px; }
    .login-status { color: #666; font-size: 12px; min-height: 18px; }
    .req-star { color: #ff4d4f; margin-left: 4px; }
  </style>
  </head>
<body>
  <div id="login-app">
    <div class="login-card">
      <div class="login-header">登录</div>
      <form id="login-form" class="login-body" autocomplete="on" onsubmit="return false;">
        <div class="login-row">
          <label for="lg-username">用户名 <span class="req-star">*</span></label>
          <input id="lg-username" name="username" class="login-input" placeholder="请输入用户名" autocomplete="username" required />
        </div>
        <div class="login-row">
          <label for="lg-password">密码 <span class="req-star">*</span></label>
          <input id="lg-password" name="password" class="login-input" type="password" placeholder="请输入密码" autocomplete="current-password" required />
        </div>
        <div class="login-row" style="display:flex;align-items:center;gap:8px;">
          <input id="lg-remember" name="remember" type="checkbox" />
          <label for="lg-remember" style="user-select:none;cursor:pointer;">记住我</label>
        </div>
        <button class="login-btn" type="button" onclick="login()">登录</button>
        <div id="lg-status" class="login-status"></div>
        <div class="login-row">
          <div style="color:#888;font-size:12px;text-align:center;">其他登录</div>
          <div id="oidc-list" style="display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:6px;"></div>
        </div>
      </form>
    </div>
  </div>

  <script src="js/cron/jquery-2.1.4.min.js"></script>
  <script>
    // 顶层跳转，确保不在右侧iframe内刷新
    function topRedirect(url){ if(window.top){ window.top.location.href = url; } else { window.location.href = url; } }

    // 简单的 Base64 UTF-8 编解码（仅作本地存储的轻度混淆，非安全加密）
    function toBase64(str){ try { return btoa(unescape(encodeURIComponent(str))); } catch(e){ return ''; } }
    function fromBase64(b64){ try { return decodeURIComponent(escape(atob(b64 || ''))); } catch(e){ return ''; } }

    // 初始化：记住我的用户名与快捷键
    (function initLogin(){
      try{
        var remembered = localStorage.getItem('rememberLogin') === '1';
        var rememberedName = localStorage.getItem('rememberUsername') || '';
        var rememberedPwdEnc = localStorage.getItem('rememberPasswordEnc') || '';
        var u = document.getElementById('lg-username');
        var p = document.getElementById('lg-password');
        var r = document.getElementById('lg-remember');
        if(r){ r.checked = !!remembered; }
        if(remembered && rememberedName && u){ u.value = rememberedName; }
        if(remembered && rememberedPwdEnc && p){ p.value = fromBase64(rememberedPwdEnc); }
        // Enter 提交；Tab 正常切换到下一个输入
        function bindShortcut(el){ if(!el) return; el.addEventListener('keydown', function(e){
          if(e.key === 'Enter'){ e.preventDefault(); login(); }
        }); }
        bindShortcut(u); bindShortcut(p);
      }catch(e){}
    })();

    // 仅使用 jQuery.ajax 的通用 JSON 请求封装
    function ajaxJson(url, method, body){
      return new Promise(function(resolve){
        $.ajax({
          url: url,
          type: method || 'GET',
          data: body ? JSON.stringify(body) : undefined,
          contentType: body ? 'application/json' : undefined,
          dataType: 'json',
          headers: { 'Accept':'application/json' },
          xhrFields: { withCredentials: true },
          crossDomain: true,
          success: function(data, _status, xhr){ resolve({ ok:true, status:xhr.status, data, getHeader: (n)=>xhr.getResponseHeader(n) }); },
          error: function(xhr){
            var payload = xhr && xhr.responseText;
            try{ payload = JSON.parse(payload); }catch(e){}
            resolve({ ok:false, status:xhr.status, data: payload, getHeader: (n)=>xhr.getResponseHeader(n) });
          }
        });
      });
    }

    async function login(){
      const username = (document.getElementById('lg-username').value || '').trim();
      const password = (document.getElementById('lg-password').value || '').trim();
      const remember = !!document.getElementById('lg-remember').checked;
      var statusEl = document.getElementById('lg-status');
      // 前端必填校验
      if(!username || !password){
        if(statusEl) statusEl.innerText = '用户名和密码为必填项';
        return;
      }
      // 记住用户名偏好
      try{
        localStorage.setItem('rememberLogin', remember ? '1' : '0');
        if(remember){
          localStorage.setItem('rememberUsername', username);
          localStorage.setItem('rememberPasswordEnc', toBase64(password));
        } else {
          localStorage.removeItem('rememberUsername');
          localStorage.removeItem('rememberPasswordEnc');
        }
      }catch(e){}

      async function tryLogin(endpoint){
        return ajaxJson(endpoint, 'POST', { username, password, remember });
      }
      let res = await tryLogin('/auth/login');
      let data = (res && res.data) ? res.data : {};
      if(res.ok && data && data.code === 0){
        var info = data.data || {};
        var name = info.username || username;
        var role = info.role || '';
        var token = info.token || '';
        // 基于响应数据角色与 token 写入本地偏好（仅用于前端体验提升）
        if(token){
          if(role === 'SUPER_ADMIN'){
            localStorage.setItem('adminToken', token);
            localStorage.setItem('adminUsername', name);
          }else{
            localStorage.setItem('userToken', token); 
            localStorage.setItem('username', name); 
          }
        }
        if(statusEl) statusEl.innerText = '登录成功，正在跳转...';
        topRedirect('/');
      }else{
        if(statusEl) statusEl.innerText = (data && data.msg) ? data.msg : ('登录失败' + (res ? ('（HTTP '+ res.status +'）') : ''));
      }
    }

    // 动态加载第三方登录列表并渲染按钮
    (async function loadOidcProviders(){
      try{
        const res = await ajaxJson('/auth/oidc/providers','GET');
        const list = (res && res.data && res.data.data) ? res.data.data : [];
        const box = document.getElementById('oidc-list');
        if(!box) return;
        box.innerHTML = '';
        list.forEach(function(p){
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'login-btn oidc-btn';
          btn.style.background = '#333';
          btn.style.fontSize = '12px';
          btn.style.padding = '8px 10px';
          btn.textContent = '使用' + ((p && p.name) ? p.name : (p && p.id ? p.id : 'OIDC')) + '登录';
          btn.onclick = function(){
            // 使用 state 传递回调后的跳转地址
            var next = encodeURIComponent('/');
            window.location.href = '/auth/oidc/start?provider=' + encodeURIComponent(p.id) + '&state=' + next;
          };
          box.appendChild(btn);
        });
      }catch(e){}
    })();
  </script>
</body>
</html>